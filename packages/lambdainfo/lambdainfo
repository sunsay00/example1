#!/bin/bash

set -e

if [[ $# != 1 ]]; then
  echo "usage: $(basename $0) <out-file>"
  exit 1
fi

OUT=$1

TMPDIR=$(mktemp -d "/tmp/$(basename $0).XXXXXXXXXXXX")
TMPFILE=$TMPDIR/tmp
touch $TMPFILE

REC=0

RET=1

while read line
do
  echo "$line"
  if [[ $REC = 1 ]] && [[ $line == "" ]]; then
    RET=0
    REC=0
  fi
  if [[ $REC = 1 ]]; then
    echo "$line" | sed 's/: /=/' >> $TMPFILE
    if grep --quiet ^ServiceEndpoint: <(echo $line); then
      echo "ApiId=`echo "$line" | sed 's/.*\/\/\([^\.]*\).*/\1/'`" >> $TMPFILE
    fi
    if grep --quiet ^ServiceEndpointWebsocket: <(echo $line); then
      echo "WebsocketApiId=`echo "$line" | sed 's/.*\/\/\([^\.]*\).*/\1/'`" >> $TMPFILE
    fi
  fi
  if [[ $line = "Stack Outputs" ]]; then
    REC=1
  fi
done < "${2:-/dev/stdin}"

if [[ $RET = 1 ]]; then
  exit 1
else
  mv "$TMPFILE" "$OUT"
  rm -rf "$TMPDIR"
fi
