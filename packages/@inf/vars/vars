#!/usr/bin/env node
// @ts-check

// @ts-ignore
const { _vars: vars } = require('./index');
const { spawn } = require('child_process');
const path = require('path');

const substitute = (arg, envs) => {
  const re = /{{([^}]+)}}/gm;
  let m = re.exec(arg);
  const keys = [];
  while (m) {
    if (m.length == 2)
      keys.push(m[1]);
    m = re.exec(arg);
  }
  return keys.reduce((a, b) => {
    const v = envs[b];
    if (!v) throw new Error(`invalid variable substitution: ${b}`);
    return a.replace(`{{${b}}}`, v);
  }, arg);
}

const argv = [];
process.argv.forEach(v => {
  if (v == '-V') {
    return;
  } else {
    argv.push(v);
  }
});

if (argv.length < 2) {
  console.log(`usage: ${path.basename(argv[1])} <cmd> [...<args>]`);
  process.exit(1);
}

if (argv.length == 2) {
  Object.entries(vars).forEach(([k, v]) => console.log(`${k}=${v}`));
} else {
  let failed = false;
  const [_1, _2, cmd, ...args] = argv;
  const proc = spawn(cmd, args.map(a => substitute(a, vars)), { env: vars, stdio: [process.stdin, process.stdout, 'pipe'] });
  proc.stderr.on('data', data => {
    if (/Unhandled rejection ServerlessError/.exec(data.toString())) // workaround for invalid return code from serverless
      failed = true;
    process.stderr.write(data.toString());
  });
  proc.on('close', code => {
    console.log('');
    process.exit(failed ? 1 : code);
  });
}
