#!/bin/bash

set -e

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"

function printusage {
  echo "usage: gen <command>"
  echo "  commands:"
  #echo "    - generate                    # generates ORM code"
  #echo "    - seed <db-url> <service-id>  # seeds the database"
  echo "    - wipetest                    # wipes out test database"
  echo "    - up                          # transitions the database to the lastest migration"
  echo "    - down                        # transitions the database to its previous migration"
}

if [[ -z ${1} ]]; then
  printusage
  exit 0
fi

CMD="$1"

if [[ $CMD == "generate" ]]; then

  if [ -L $DIR/gen ]; then
    GENDIR=`dirname $DIR/$(readlink $DIR/gen)`
  else
    GENDIR="$DIR"
  fi

  if [ ! -f $GENDIR/../../../ledger.scm ]; then
    echo "ledger.scm file not found";
    exit 1
  fi

  cd $GENDIR/generator/ && LEDGER_PATH=$GENDIR/../../../ledger.scm make configure

elif [[ $CMD == "seed" ]]; then

  if [[ -z "${2}" ]] || [[ -z "${3}" ]]; then
    echo "invalid arguments to 'seed subcommand"
    printusage
    exit 1
  fi

  DB_URL="${2}"
  SERVICE_ID="${3}"

  ${DIR}/seed ${DB_URL} ${SERVICE_ID}

elif [[ $CMD == "wipetest" ]]; then

  VARSDIR=${DIR}/../../packages/@inf/cf-gen
  if [ ! -f "$VARSDIR/vars" ]; then
    echo "invalid vars file - (looked in ${VARSDIR})";
  fi
  source ${VARSDIR}/vars
  if [[ -z "$DB_TEST_URL" ]]; then
    echo "undefined db test url"
  fi

  echo $DB_TEST_URL

elif [[ $CMD == "up" ]]; then

  VARSDIR=${DIR}/../../packages/@inf/cf-gen
  if [ ! -f "$VARSDIR/vars" ]; then
    echo "invalid vars file - (looked in ${VARSDIR})";
  fi
  source ${VARSDIR}/vars
  if [[ -z "$DB_URL" ]]; then
    echo "undefined db test url"
  fi
  
  DB=${DB_URL} yarn db-migrate up --migrations-dir ${VARSDIR}/infra/postgres/migrations --config ${VARSDIR}/database.json

elif [[ $CMD == "down" ]]; then

  VARSDIR=${DIR}/../../packages/@inf/cf-gen
  if [ ! -f "$VARSDIR/vars" ]; then
    echo "invalid vars file - (looked in ${VARSDIR})";
  fi
  source ${VARSDIR}/vars
  if [[ -z "$DB_URL" ]]; then
    echo "undefined db test url"
  fi
  
  DB=${DB_URL} yarn db-migrate down --migrations-dir ${VARSDIR}/infra/postgres/migrations --config ${VARSDIR}/database.json

else
  echo "unknown command: ${CMD}"
  printusage
  exit 1
fi