#!/bin/bash

set -e

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"

if [ -L $DIR/gen ]; then
  GENDIR=`dirname $DIR/$(readlink $DIR/gen)`
else
  GENDIR="$DIR"
fi

function runsql { echo "$2" | psql "$1"; }

function printusage {
  echo "usage: gen <command>"
  echo "  commands:"
  #echo "    - generate                    # generates ORM code"
  #echo "    - seed <db-url> <service-id>  # seeds the database"
  echo "    - wipetest                    # wipes out test database"
  echo "    - up                          # transitions the database to the lastest migration"
  echo "    - down                        # transitions the database to its previous migration"
  echo "    - shell                       # connects to localdb"
}

if [[ -z ${1} ]]; then
  printusage
  exit 0
fi

CMD="$1"

if [[ $CMD == "generate" ]]; then

  if [ ! -f $GENDIR/../../../ledger.scm ]; then
    echo "ledger.scm file not found";
    exit 1
  fi

  cd $GENDIR/generator/ && LEDGER_PATH=$GENDIR/../../../ledger.scm make configure

elif [[ $CMD == "seed" ]]; then

  if [[ -z "${2}" ]] || [[ -z "${3}" ]]; then
    echo "invalid arguments to 'seed subcommand"
    printusage
    exit 1
  fi

  DB_URL="${2}"
  SERVICE_ID="${3}"

  #${DIR}/seed ${DB_URL} ${SERVICE_ID}

  #DB=${DB_URL} yarn db-migrate up --migrations-dir ${GENDIR}/infra/postgres/migrations --config ${GENDIR}/database.json

elif [[ $CMD == "wipetest" ]]; then

  if [ ! -f "$GENDIR/vars.env" ]; then
    echo "invalid vars.env file - (looked in ${GENDIR})";
  fi
  source ${GENDIR}/vars.env
  if [[ -z "$DB_TEST_URL" ]] || [[ -z "$DB_URL" ]]; then
    echo "undefined db urls"
  fi

  runsql "${DB_URL}" "DROP DATABASE IF EXISTS testlocal"
  runsql "${DB_URL}" "CREATE DATABASE testlocal"

  ${GENDIR}/seed ${DB_TEST_URL} 0

  cd "$GENDIR" && DB=${DB_TEST_URL} yarn db-migrate up --migrations-dir ${GENDIR}/infra/postgres/migrations --config ${GENDIR}/database.json

elif [[ $CMD == "up" ]]; then

  if [ ! -f "$GENDIR/vars.env" ]; then
    echo "invalid vars.env file - (looked in ${GENDIR})";
  fi
  source ${GENDIR}/vars.env
  if [[ -z "$DB_URL" ]]; then
    echo "undefined db url"
  fi
  
  DB=${DB_URL} yarn db-migrate up --migrations-dir ${GENDIR}/infra/postgres/migrations --config ${GENDIR}/database.json

elif [[ $CMD == "down" ]]; then

  if [ ! -f "$GENDIR/vars.env" ]; then
    echo "invalid vars.env file - (looked in ${GENDIR})";
  fi
  source ${GENDIR}/vars.env
  if [[ -z "$DB_URL" ]]; then
    echo "undefined db url"
  fi
  
  DB=${DB_URL} yarn db-migrate down --migrations-dir ${GENDIR}/infra/postgres/migrations --config ${GENDIR}/database.json

elif [[ $CMD == "shell" ]]; then

  if [ ! -f "$GENDIR/vars.env" ]; then
    echo "invalid vars.env file - (looked in ${GENDIR})";
  fi
  source ${GENDIR}/vars.env
  if [[ -z "$DB_URL" ]]; then
    echo "undefined db test url"
  fi

  pgcli "$DB_URL"

else
  echo "unknown command: ${CMD}"
  printusage
  exit 1
fi