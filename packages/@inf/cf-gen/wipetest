#!/bin/bash

set -e

if [ -z ${STAGE} ] || [ -z ${DB_URL} ] || [ -z ${DB_TEST_URL} ] || [ -z ${GENDIR} ]; then
  echo "following envars must be defined STAGE, DB_URL, DB_TEST_URL GENDIR"
fi

DB=`yarn -s vars echo ${DB_URL}`
DB_TEST=`yarn -s vars echo ${DB_TEST_URL}`

psql -c "DROP DATABASE IF EXISTS test${STAGE}" ${DB}
psql -c "CREATE DATABASE test${STAGE}" ${DB}

${GENDIR}/seed ${DB_TEST} 0

cd "$GENDIR" && DB=${DB_TEST} yarn -s db-migrate up --migrations-dir ${GENDIR}/infra/postgres/migrations --config ${GENDIR}/database.json