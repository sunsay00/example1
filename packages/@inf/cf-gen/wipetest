#!/bin/bash

set -e


if [ -z ${STAGE} ]; then
  echo "following envars must be defined STAGE"
  exit 1
fi
if [ -z ${DB_URL} ]; then
  echo "following envars must be defined DB_URL"
  exit 1
fi
if [ -z ${DB_TEST_URL} ]; then
  echo "following envars must be defined DB_TEST_URL"
  exit 1
fi
if [ -z ${GENDIR} ]; then
  echo "following envars must be defined GENDIR"
  exit 1
fi

DB=`yarn -s vars echo ${DB_URL}`
DB_TEST=`yarn -s vars echo ${DB_TEST_URL}`

psql -c "DROP DATABASE IF EXISTS test${STAGE}" ${DB}
psql -c "CREATE DATABASE test${STAGE}" ${DB}

${GENDIR}/seed ${DB_TEST} 0

cd "$GENDIR" && DB=${DB_TEST} yarn -s db-migrate up --migrations-dir ${MIGRATIONS_DIR} --config ${DATABASE_JSON_PATH}