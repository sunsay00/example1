#!/bin/bash

set -e

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

if [[ -z "$1" ]] || [[ -z "$2" ]]; then
  echo "usage $0 <connection-str> <service-id>"
  echo "  note: service-id must be globally unique per database instance for proper federation"
  exit 1
fi

DB="$1"
SERVICEID="$2"

function run { echo "$1;" | psql $DB; }
HAS_BEEN_SEEDED=$(run "SELECT count(table_name) FROM information_schema.tables WHERE table_name='serviceid';" | tail -n +3 | grep "[0-9]$" | tr -d ' ')
if [[ $HAS_BEEN_SEEDED == 1 ]]; then
  echo "this database has already been seeded"
  exit 0
fi

# SEED
run "DROP SEQUENCE IF EXISTS global_id_sequence"
run "DROP TABLE IF EXISTS serviceId"

run "REVOKE ALL ON schema public FROM public; \
 CREATE TABLE serviceId (id INT); \
 INSERT INTO serviceId (id) VALUES(${SERVICEID}); \
 CREATE SEQUENCE global_id_sequence; \
 CREATE EXTENSION IF NOT EXISTS postgis; \
 CREATE EXTENSION IF NOT EXISTS citext"

#cd ${DIR}/.. && DB=${DB} sh ${DIR}/migrate up
